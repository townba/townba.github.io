(()=>{class e{static encoder=new TextEncoder;static decoder=new TextDecoder("ascii");device=void 0;inEndpoint=void 0;outEndpoint=void 0;readBuffer="";static BC125AT_PRODUCT_ID=23;static BCD325P2_PRODUCT_ID=26;static VENDOR_ID=6501;static USB_CDC_DATA=10;eventCallback=(e,t)=>{};constructor(e){e&&(this.eventCallback=e)}async connect(){if(this.device)return Promise.reject(new Error("already connected"));const t=await navigator.usb.getDevices();let n;if(n=1==t.length&&t[0]?t[0]:await navigator.usb.requestDevice({filters:[{vendorId:e.VENDOR_ID,productId:e.BC125AT_PRODUCT_ID},{vendorId:e.VENDOR_ID,productId:e.BCD325P2_PRODUCT_ID}]}),!n)return Promise.reject(new Error("nothing connected"));this.device=n,await n.open(),this.eventCallback("log","device is open");for(const t of n.configurations)for(const i of t.interfaces)for(const o of i.alternates){if(o.interfaceClass!==e.USB_CDC_DATA)continue;let s,r;for(const e of o.endpoints)if("bulk"===e.type&&("in"===e.direction?s=e.endpointNumber:"out"===e.direction&&(r=e.endpointNumber),s&&r))return this.inEndpoint=s,this.outEndpoint=r,this.eventCallback("log","endpoints found"),n.selectConfiguration(t.configurationValue).then((()=>n.claimInterface(i.interfaceNumber)))}throw this.eventCallback("log","endpoints not found"),new Error("endpoints not found")}async close(){if(!this.device)return Promise.resolve();try{return await this.device.close()}finally{this.device=void 0,this.inEndpoint=void 0,this.outEndpoint=void 0}}async sendCommand(e,t){const n=e.split(",")[0]??"";if("$"==n.charAt(0)&&e.replace(/\*[0-9A-F]{2}$/,""),await this.write(e),this.eventCallback("sent",e),"$"!=n.charAt(0))return await this.read(n,t)}latlongAsGPSString(e,t){if(null==e)return",";const n=Math.round(60*Math.abs(e)*1e4);return Math.floor(n/6e5).toString().padStart(t?3:2,"0")+(n/1e4%60).toFixed(4).padStart(7,"0")+","+(e<0?t?"W":"S":t?"E":"N")}clampNumber(e,t,n){return e<t?t:e>n?n:e}wrapDegrees(e){return(e%360+360)%360}static calculateNMEA0183Checksum(e){return"*"+e.split("").map((e=>e.charCodeAt(0))).reduce(((e,t)=>e^t)).toString(16).toUpperCase()}async sendGPSInformation(t){const n=new Date,i=n.getUTCHours().toString().padStart(2,"0")+n.getUTCMinutes().toString().padStart(2,"0")+n.getUTCSeconds().toString().padStart(2,"0"),o=this.latlongAsGPSString(this.clampNumber(t.latitude,-90,90),!1),s=this.latlongAsGPSString(this.wrapDegrees(t.longitude+180)-180,!0),r=null==t.altitude?"":this.clampNumber(Math.round(t.altitude),Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER).toString(),a=`GPRMC,${i},A,${o},${s},${null==t.speed?"":(1.94384449244*this.clampNumber(t.speed,0,299792458)).toFixed(0)},${null==t.heading?"":this.wrapDegrees(Math.round(t.heading)).toString().padStart(3,"0")}`;let c="$"+a+e.calculateNMEA0183Checksum(a);this.eventCallback("log","trying to write: "+c),await this.write(c),this.eventCallback("sent",c);const l=`GPGGA,,,,,,,,,${r},M`;return c="$"+l+e.calculateNMEA0183Checksum(l),this.eventCallback("log","trying to write: "+c),await this.write(c),this.eventCallback("sent",c),Promise.resolve()}async write(t){return this.device&&void 0!==this.outEndpoint?(await this.device.transferOut(this.outEndpoint,e.encoder.encode(t+"\r")),Promise.resolve()):Promise.reject(new Error("not connected"))}async read(t,n=200){const i=Date.now();if(!this.device||void 0===this.inEndpoint)return Promise.reject(new Error("not connected"));const o=new Promise(((e,i)=>{setTimeout((()=>{i(new Error("timed out: "+t))}),n)})),s=await Promise.race([this.device.transferIn(this.inEndpoint,4096),o]);let r;for(s instanceof USBInTransferResult&&s.data&&(this.readBuffer+=e.decoder.decode(s.data));(r=this.readBuffer.indexOf("\r"))>=0;){const e=this.readBuffer.slice(0,r);if(this.readBuffer=this.readBuffer.slice(r+1),e.split(",")[0]===t)return void this.eventCallback("response",e)}return n-(Date.now()-i)>0?this.read(t,n):Promise.reject(new Error("timed out"))}}let t,n,i,o;class s{static invalidTagRegExp=/[^\x20-\x2B\x2D-\x7E]/g;static ctcssTones=[67,69.3,71.9,74.4,77,79.7,82.5,85.4,88.5,91.5,94.8,97.4,100,103.5,107.2,110.9,114.8,118.8,123,127.3,131.8,136.5,141.3,146.2,151.4,156.7,159.8,162.2,165.5,167.9,171.3,173.8,177.3,179.9,183.5,186.2,189.9,192.8,196.6,199.5,203.5,206.5,210.7,218.1,225.7,229.1,233.6,241.8,250.3,254.1];static dcsCodes=[23,25,26,31,32,36,43,47,51,53,54,65,71,72,73,74,114,115,116,122,125,131,132,134,143,145,152,155,156,162,165,172,174,205,212,223,225,226,243,244,245,246,251,252,255,261,263,265,266,271,274,306,311,315,325,331,332,343,346,351,356,364,365,371,411,412,413,423,431,432,445,446,452,454,455,462,464,465,466,503,506,516,523,526,532,546,565,606,612,624,627,631,632,654,662,664,703,712,723,731,732,734,743,754];_location;_name;_frequency;modulation;_toneCode;_delay;lockout;priority;constructor(){this._location=1,this._name="",this._frequency=0,this.modulation=s.Modulation.AUTO,this._toneCode=0,this._delay=2,this.lockout=!1,this.priority=!1}isEmpty(){return""===this._name&&0===this._frequency}static isValidLocation(e){return e>=1&&e<=500}get location(){return this._location}set location(e){s.isValidLocation(e)&&(this._location=e)}static isValidName(e){return!e.match(this.invalidTagRegExp)&&e.length<=16}get name(){return this._name}set name(e){this._name=e.replace(s.invalidTagRegExp,"?").slice(0,16)}static isValidFrequency(e){return 0===e||e>=25e6&&e<=54e6||e>=108e6&&e<=174e6||e>=225e6&&e<=38e7||e>=4e8&&e<=512e6}get frequency(){return this._frequency}set frequency(e){s.isValidFrequency(e)&&(this._frequency=e)}static isValidCtcssTone(e){return s.ctcssTones.indexOf(e)>=0}static isValidDcsCode(e){return s.dcsCodes.indexOf(e)>=0}get toneCode(){return this._toneCode}set ctcssTone(e){const t=s.ctcssTones.indexOf(e);t>=0&&(this._toneCode=t+64)}set dcsCode(e){const t=s.dcsCodes.indexOf(e);t>=0&&(this._toneCode=t+128)}setCtcssDcsOff(){this._toneCode=0}setCtcssDcsSearch(){this._toneCode=127}setCtcssDcsNone(){this._toneCode=240}static isValidDelay(e){return[-10,-5,0,1,2,3,4,5].indexOf(e)>=0}get delay(){return this._delay}set delay(e){this._delay=e<=-7.5?-10:e<0?-5:e<.5?0:e<1.5?1:e<2.5?2:e<3.5?3:e<4.5?4:5}getCommand(){let e="AUTO";switch(this.modulation){case s.Modulation.AUTO:e="AUTO";break;case s.Modulation.AM:e="AM";break;case s.Modulation.FM:e="FM";break;case s.Modulation.NFM:e="NFM"}return["CIN",this.location,""===this.name?" ":this.name,("00000000"+Math.floor(this.frequency/100)).slice(-8),e,this.toneCode,this.delay,this.lockout?"1":"0",this.priority?"1":"0"].join(",")}}let r;function a(e){if(e instanceof HTMLTextAreaElement)return function(t,n){if(e.value+="["+t+"] "+n+"\n",e.scrollTop=e.scrollHeight,"response"===t){const e=n.split(",");if(e.length>=2&&void 0!==e[1]&&["ERR","NG"].includes(e[1])){const e=document.getElementById("error_count");e&&(e.innerText=(parseInt(e.innerText)+1).toString())}}}}function c(){void 0!==o&&t&&t.sendGPSInformation(o),n=window.setTimeout(c,2e3)}function l(e,t){return"# Import error"+(e?", line "+e:"")+": "+t}function d(e,t){return"# Import warning"+(e?", line "+e:"")+": "+t}function u(e,t,n,{header:i,lineNumber:o,warningMessage:s,errorMessage:r}){const a=parseInt(e??"");if(Number.isNaN(a)||a<t||a>n){if(r)return void i.push(l(o,r+": "+e));if(s)return void i.push(d(o,s+": "+e))}return a}function h(e,t,n,i){return i.push(d(0,"not all settings are imported")),e.split("\n").map((e=>e.replace("\r",""))).map(((e,o)=>{const r=o+1;if(e.startsWith("Misc\t")&&n){const t=e.split("\t"),n={Off:"AF",On:"AO",Squelch:"SQ",Key:"KY","K+S":"KS"}[t[1]??""]??void i.push(d(r,"invalid backlight")),o={Auto:0,Off:99}[t[2]??""]??void i.push(d(r,"invalid key beep")),s={On:1,Off:0}[t[3]??""]??void i.push(d(r,"invalid key lock")),a=u(t[4],1,15,{header:i,lineNumber:r,warningMessage:"invalid contrast"}),c=u(t[5],1,14,{header:i,lineNumber:r,warningMessage:"invalid charge time"}),l=u(t[6],0,15,{header:i,lineNumber:r,warningMessage:"invalid volume"}),h=u(t[7],0,15,{header:i,lineNumber:r,warningMessage:"invalid squelch"}),f={USA:0,Canada:1}[t[8]??""]??(i.push(d(r,"invalid band plan")),0);return[void 0!==n?["# Backlight","BLT,"+n]:[],void 0!==o&&void 0!==s?["# Key beep and lock","KBP,"+o+","+s]:[],void 0!==a?["# Contrast","CNT,"+a]:[],void 0!==c?["# Battery charge time","BSV,"+c]:[],void 0!==l?["# Volume","VOL,"+l]:[],void 0!==h?["# Squelch","SQL,"+h]:[],void 0!==f?["# Band plan","BPL,"+f]:[]].flat().join("\n")}if(e.startsWith("Priority\t")&&n){const t=e.split("\t");if(t.length<2)return"";const n={Off:0,On:1,Plus:2,DND:3}[t[1]??""]??void i.push(d(r,"invalid priority"));return void 0!==n?`# Priority\nPRI,${n}`:""}if(e.startsWith("WxPri\t")&&n){const t=e.split("\t");if(t.length<2)return"";const n={Off:0,On:1}[t[1]??""]??void i.push(d(r,"invalid weather alert priority"));return void 0!==n?`# Weather alert priority\nWXS,${n}`:""}if(!e.startsWith("C-Freq\t"))return"";const a=e.split("\t"),c=new s,h=parseInt(a[1]??"");if(!s.isValidLocation(h))return i.push(l(r,"invalid location: "+a[1])),"";c.location=h;const f=a[2];void 0===f?i.push(d(r,`[channel ${c.location}] no name given`)):(s.isValidName(f)||i.push(d(r,`[channel ${c.location}] invalid name, modifying/truncating: `+a[2])),c.name=f);const p=parseInt(a[3]??"");if(s.isValidFrequency(p)?c.frequency=p:i.push(d(r,`[channel ${c.location}] invalid frequency: `+a[3])),c.isEmpty())return t?"DCH,"+c.location:"";const m={Auto:s.Modulation.AUTO,AM:s.Modulation.AM,FM:s.Modulation.FM,NFM:s.Modulation.NFM}[a[4]??""];if(void 0!==m?c.modulation=m:i.push(d(r,`[channel ${c.location}] invalid mode: `+a[4])),c.setCtcssDcsSearch(),"Off"===a[5])c.setCtcssDcsOff();else if("Srch"===a[5])c.setCtcssDcsSearch();else if("NoTone"===a[5])c.setCtcssDcsNone();else if(void 0!==a[5]&&a[5].match(/^[CD]/)){const e=parseFloat(a[5].slice(1));"C"===a[5][0]?s.isValidCtcssTone(e)?c.ctcssTone=e:i.push(d(r,`[channel ${c.location}] invalid CTCSS tone: `+a[5])):"D"===a[5][0]&&(s.isValidDcsCode(e)?c.dcsCode=e:i.push(d(r,`[channel ${c.location}] invalid DCS code: `+a[5])))}else void 0!==a[5]&&i.push(d(r,`[channel ${c.location}] unknown CTCSS/DCS setting: `+a[5]));const v={On:!0,Off:!1},g=v[a[6]??""];void 0!==g?c.lockout=g:i.push(d(r,`[channel ${c.location}] invalid lockout: `+a[6]));const C=parseFloat(a[7]??"");s.isValidDelay(C)?c.delay=C:i.push(d(r,`[channel ${c.location}] invalid delay: `+a[7]));const y=v[a[8]??""];return void 0!==y?c.priority=y:i.push(d(r,`[channel ${c.location}] invalid priority: `+a[8])),c.getCommand()})).filter((e=>e))}function f(e,t,n){const i=[],o=function(e){const t=/^(?:(?<nonescaped>[^\x00-\x1F",]+)|(?:"(?<escaped>(?:[^"]|"")*)")|)(?<next>[,\n]|\r\n|$)/,n=[];let i=[];for(;e;){const o=t.exec(e);if(!o||void 0===o[0]||!o.groups)throw new Error("invalid CSV");e=e.slice(o[0].length);let s="";const r=o.groups.nonescaped,a=o.groups.escaped,c=o.groups.next;if(void 0!==r?s=r:void 0!==a&&(s=a.replace(/""/g,'"')),i.push(s),","===c);else{if(!(c&&["\n","\r\n"].indexOf(c)>=0))return n.push(i),n;n.push(i),i=[]}}return i.length&&n.push(i),n}(e);if(!o)return n.push(l(0,"empty file")),[];const r=o[0];let a,c,u,h,f,p,m,v,g;if(r&&(a=r.indexOf("Location"),c=r.indexOf("Name"),u=r.indexOf("Frequency"),h=r.indexOf("Tone"),f=r.indexOf("cToneFreq"),p=r.indexOf("rToneFreq"),m=r.indexOf("DtcsCode"),v=r.indexOf("Mode"),g=r.indexOf("Skip")),void 0===a)return n.push(l(0,"Location field not found")),[];if(void 0===u)return n.push(l(0,"Frequency field not found")),[];for(let e=1;e<o.length;++e){const r=e+1,C=o[e];if(void 0===C){n.push(l(r,"invalid row"));continue}const y=new s,w=parseInt(C[a]??"");if(s.isValidLocation(w))y.location=w;else{if(0!==w){n.push(l(r,"invalid location: "+C[a]));continue}n.push(d(r,"invalid location 0, using channel 500")),y.location=500}if(void 0!==c){const e=C[c];void 0===e?n.push(d(r,`[channel ${y.location}] no name given`)):(s.isValidName(e)||n.push(d(r,`[channel ${y.location}] invalid name, modifying/truncating: `+C[c])),y.name=e)}const S=1e6*parseInt(C[u]??"");if(s.isValidFrequency(S)?y.frequency=S:n.push(d(r,`[channel ${y.location}] invalid frequency: `+C[u])),y.isEmpty())t&&i.push("DCH,"+y.location);else{if(void 0!==v){const e={Auto:s.Modulation.AUTO,AM:s.Modulation.AM,FM:s.Modulation.FM,NFM:s.Modulation.NFM}[C[v]??""];void 0!==e?y.modulation=e:n.push(d(r,`[channel ${y.location}] invalid mode: `+C[v]))}if(y.setCtcssDcsSearch(),void 0!==h){const e=C[h]??"";if("TSQL"===e||"Tone"===e){let t=f,i=p;"TSQL"===e&&(t=p,i=f);try{let e=t;void 0===e&&(e=i);const o=void 0!==e?C[e]:void 0;if(void 0===o)throw new Error("no CTCSS tone given");const a=parseFloat(o);s.isValidCtcssTone(a)?y.ctcssTone=a:n.push(d(r,`[channel ${y.location}] invalid CTCSS tone: `+C[h]))}catch(e){n.push(d(r,`[channel ${y.location}] error with CTCSS tone: `+(e instanceof Error)?e.message:"unknown"))}}else if("DTCS"===e)try{const e=void 0!==m?C[m]:void 0;if(void 0===m||void 0===e)throw new Error("no DCS code given");const t=parseFloat(e);s.isValidCtcssTone(t)?y.dcsCode=t:n.push(d(r,`[channel ${y.location}] invalid DCS code: `+C[m]))}catch(e){n.push(d(r,`[channel ${y.location}] error with DCS code: `+(e instanceof Error)?e.message:"unknown"))}else""!==e&&n.push(d(r,`[channel ${y.location}] unsupported tone mode`))}if(void 0!==g){const e=C[g]??"";""===e||("S"===e?y.lockout=!0:"P"===e?y.priority=!0:n.push(d(r,`[channel ${y.location}] unsupported skip setting`)))}i.push(y.getCommand())}}return i}function p(){const e=document.getElementById("input");if(e){const t=e.getAttribute("data-original");r.value=t??""}}!function(e){let t;!function(e){e[e.AUTO=0]="AUTO",e[e.AM=1]="AM",e[e.FM=2]="FM",e[e.NFM=3]="NFM"}(t=e.Modulation||(e.Modulation={}))}(s||(s={})),window.clearResponses=function(){const e=document.getElementById("output");e instanceof HTMLTextAreaElement&&(e.value="")},window.sendCommands=async function(){let n=!1;const i=document.getElementById("output");if(i instanceof HTMLTextAreaElement&&(t||(t=new e(a(i)),n=!0)),!t)return Promise.reject(new Error("unable to create UnidenScanner class"));try{if(n)try{await t.connect()}catch(e){return void(t=void 0)}const e=r.value.split("\n").filter((e=>{const t=e;return t.length>0&&"#"!==t[0]}));for(const n of e)await t.sendCommand(n,"CLR"===n?3e4:void 0);return Promise.resolve()}catch(e){return Promise.reject(new Error((Error,e.message)))}},window.toggleWatchGPSPosition=async function(){const e=document.getElementById("gps_info");return i?(navigator.geolocation.clearWatch(i),i=void 0,e&&(e.innerText="(stopped) "+e.innerText)):i=navigator.geolocation.watchPosition((t=>{o=t.coords,e&&(e.innerText=(new Date).toString()+": "+JSON.stringify(t.coords))})),Promise.resolve()},window.toggleSendGPSTimer=async function(){let i=!1;const o=document.getElementById("output");if(o instanceof HTMLTextAreaElement&&(t||(t=new e(a(o)),i=!0)),!t)return Promise.reject(new Error("unable to create UnidenScanner class"));try{if(i)try{await t.connect()}catch(e){return void(t=void 0)}return n?(clearTimeout(n),n=void 0):c(),Promise.resolve()}catch(e){return Promise.reject(new Error((Error,e.message)))}},window.importFile=function(){const e=document.getElementById("delete_empty_channels"),t=document.getElementById("import_all_settings");let n=!1;e instanceof HTMLInputElement&&(n=e.checked);let i=!1;t instanceof HTMLInputElement&&(i=t.checked);const o=document.createElement("input");o.accept=".bc125at_ss,.csv,.tsv,.txt,text/csv,text/plain,text/tab-separated-values",o.type="file",o.onchange=async e=>{if(!o.files)return Promise.resolve();r.value="";const t=[];n||t.push(d(0,"ignored empty channels")),i||t.push(d(0,"dropping non-channel settings"));const s=["# Enter programming mode","PRG"];for(const e of o.files){t.push("# Imported "+e.name),t.push("# Last modified "+new Date(e.lastModified).toString());const o=await e.text();o.match("^(C-Freq|CloseCall|CloseCallBands|Conventional|Custom|GeneralSearch|Misc|Priority|Service|WxPri)\t")?s.push.apply(s,h(o,n,i,t)):o.match(/^[0-9.]+\r?\n/)||(o.match(/\t/)?t.push(l(1,"unknown file format")):s.push.apply(s,f(o,n,t)))}s.push("# Exit programming mode\nEPG"),r.value=t.concat(s).join("\n")+"\n"},o.click()},window.resetCommands=p,document.addEventListener("DOMContentLoaded",(function(){const e="usb"in navigator,t=document.getElementById("supported");t&&(t.innerText=e?"appears to be":"is not");const n=document.getElementById("send");n instanceof HTMLInputElement&&(n.disabled=!e);const i=document.getElementById("input");i&&(r=i,i.focus()),p()}),!1)})();