let e,l,n;function u(a,b){if(null==a)return",";const f=Math.round(6E5*Math.abs(a));return Math.floor(f/6E5).toString().padStart(b?3:2,"0")+(f/1E4%60).toFixed(4).padStart(7,"0")+","+(0>a?b?"W":"S":b?"E":"N")}function w(a,b,f){return a<b?b:a>f?f:a}function x(a){return a+"*"+a.split("").map(b=>b.charCodeAt(0)).reduce((b,f)=>b^f).toString(16).toUpperCase().padStart(2,"0")}
async function aa(){var a=n;if(E){var b=new Date;b=b.getUTCHours().toString().padStart(2,"0")+b.getUTCMinutes().toString().padStart(2,"0")+b.getUTCSeconds().toString().padStart(2,"0");var f=u(w(a.latitude,-90,90),!1),k=u(((a.longitude+180)%360+360)%360-180,!0),c=null==a.altitude?"":w(Math.round(a.altitude),Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER).toString();await E.write("$"+x(`GPRMC,${b},A,`+`${f},${k},${null==a.speed?"":(1.94384449244*w(a.speed,0,299792458)).toFixed(0)},`+`${null==a.heading?
"":((Math.round(a.heading)%360+360)%360).toString().padStart(3,"0")}`));await E.write("$"+x(`GPGGA,${b},`+`${f},${k},1,,,${c},M`))}}async function ca(){const a=document.getElementById("gps_info");l?(navigator.geolocation.clearWatch(l),l=void 0,a&&(a.innerText="(stopped) "+a.innerText)):l=navigator.geolocation.watchPosition(b=>{n=b.coords;a&&(a.innerText=(new Date).toString()+": "+JSON.stringify(b.coords))})}
window.toggleWatchGPSPositionSync=function(){try{ca()}catch(a){alert("Aborting toggling watching GPS position: "+(a instanceof Error)?a.message:"unknown")}};async function da(){"undefined"!==typeof n&&E&&await aa();e=window.setTimeout(da,2E3)}async function ea(){const a=document.getElementById("output");let b=!1;a instanceof HTMLTextAreaElement&&!E&&(E=new F(H(a)),b=!0);if(!E)throw Error("Unable to create UnidenScanner class.");b&&await E.open();e?(clearTimeout(e),e=void 0):await da()}
window.toggleSendGPSTimerSync=function(){try{ea()}catch(a){alert("Aborting sending GPS information: "+(a instanceof Error)?a.message:"unknown")}};window.importFile=function(){const a=document.getElementById("delete_empty_channels"),b=document.getElementById("import_all_settings");let f=!1;a instanceof HTMLInputElement&&(f=a.checked);let k=!1;b instanceof HTMLInputElement&&(k=b.checked);const c=document.createElement("input");c.accept=".bc125at_ss,.csv,.tsv,.txt,text/csv,text/plain,text/tab-separated-values";c.type="file";c.onchange=async()=>{if(c.files){I.value="";var d=[];f||d.push(N(0,"ignored empty channels"));k||d.push(N(0,"dropping non-channel settings"));
var h=["# Enter programming mode","PRG"];for(const S of c.files){d.push("# Imported "+S.name);d.push("# Last modified "+(new Date(S.lastModified)).toString());var g=await S.text();if(g.match("^(C-Freq|CloseCall|CloseCallBands|Conventional|Custom|GeneralSearch|Misc|Priority|Service|WxPri)\t"))h.push(...fa(g,f,k,d));else if(!g.match(/^[0-9.]+\r?\n/))if(g.match(/\t/))d.push(O(1,"unknown file format"));else{var y=h,z=y.push;{let T=void 0,J=void 0,G=void 0,U=void 0,V=void 0,K=void 0,L=void 0,M=void 0;
var A=f;const W=[];b:{for(var B=/^(?:(?<nonescaped>[^\u0000-\u001F",]+)|(?:"(?<escaped>(?:[^"]|"")*)")|)(?<next>[,\n]|\r\n|$)/,q=[],t=[];g;){var p=B.exec(g);if(!p||void 0===p[0]||!p.groups)throw Error("invalid CSV");g=g.slice(p[0].length);var m="",r=p.groups.nonescaped,v=p.groups.escaped;p=p.groups.next;void 0!==r?m=r:void 0!==v&&(m=v.replace(/""/g,'"'));t.push(m);if(","!==p)if(p&&0<=["\n","\r\n"].indexOf(p))q.push(t),t=[];else{q.push(t);g=q;break b}}t.length&&q.push(t);g=q}if(g)if(q=g[0],B=void 0,
q&&(B=q.indexOf("Location"),M=q.indexOf("Name"),L=q.indexOf("Frequency"),K=q.indexOf("Tone"),V=q.indexOf("cToneFreq"),U=q.indexOf("rToneFreq"),G=q.indexOf("DtcsCode"),J=q.indexOf("Mode"),T=q.indexOf("Skip")),void 0===B)d.push(O(0,"Location field not found")),A=[];else if(void 0===L)d.push(O(0,"Frequency field not found")),A=[];else{for(q=1;q<g.length;++q)if(t=q+1,r=g[q],void 0===r)d.push(O(t,"invalid row"));else{m=new P;v=parseInt(r[B]??"");if(1<=v&&500>=v)m.location=v;else if(0===v)d.push(N(t,"invalid location 0, using channel 500")),
m.location=500;else{d.push(O(t,"invalid location: "+r[B]));continue}void 0!==M&&(p=r[M],void 0===p?d.push(N(t,`[channel ${m.location}] no name given`)):(v=p,!v.match(P.A)&&16>=v.length||d.push(N(t,`[channel ${m.location}] `+"invalid name, modifying/truncating: "+r[M])),m.name=p));v=1E6*parseInt(r[L]??"");Q(v)?m.frequency=v:d.push(N(t,`[channel ${m.location}] invalid frequency: `+r[L]));if(""===m.l&&0===m.j)A&&W.push("DCH,"+m.location);else{void 0!==J&&(v={Auto:P.g.v,AM:P.g.G,FM:P.g.H,NFM:P.g.I}[r[J]??
""],void 0!==v?m.C=v:d.push(N(t,`[channel ${m.location}] invalid mode: `+r[J])));m.h=127;if(void 0!==K)if(p=r[K]??"","TSQL"===p||"Tone"===p){let C=V;v=U;"TSQL"===p&&(C=U,v=V);try{p=C;void 0===p&&(p=v);const D=void 0!==p?r[p]:void 0;if(void 0===D)throw Error("no CTCSS tone given");const ba=parseFloat(D);0<=P.m.indexOf(ba)?m.L=ba:d.push(N(t,`[channel ${m.location}] invalid CTCSS tone: `+r[K]))}catch(D){d.push(N(t,`[channel ${m.location}] error with CTCSS tone: `+(D instanceof Error)?D.message:"unknown"))}}else if("DTCS"===
p)try{const C=void 0!==G?r[G]:void 0;if(void 0===G||void 0===C)throw Error("no DCS code given");const D=parseFloat(C);0<=P.m.indexOf(D)?m.M=D:d.push(N(t,`[channel ${m.location}] invalid DCS code: `+r[G]))}catch(C){d.push(N(t,`[channel ${m.location}] error with DCS code: `+(C instanceof Error)?C.message:"unknown"))}else""!==p&&d.push(N(t,`[channel ${m.location}] unsupported tone mode`));void 0!==T&&(r=r[T]??"",""!==r&&("S"===r?m.B=!0:"P"===r?m.priority=!0:d.push(N(t,`[channel ${m.location}] unsupported skip setting`))));
W.push(m.getCommand())}}A=W}else d.push(O(0,"empty file")),A=[]}z.call(y,...A)}}h.push("# Exit programming mode\nEPG");I.value=d.concat(h).join("\n")+"\n"}};c.click()};function O(a,b){return"# Import error"+(a?", line "+a:"")+": "+b}function N(a,b){return"# Import warning"+(a?", line "+a:"")+": "+b}function R(a,b,f,{o:k,lineNumber:c,u:d,errorMessage:h}){const g=parseInt(a??"");if(Number.isNaN(g)||g<b||g>f){if(h){k.push(O(c,h+": "+a));return}if(d){k.push(N(c,d+": "+a));return}}return g}
function fa(a,b,f,k){k.push(N(0,"not all settings are imported"));return a.split("\n").map(c=>c.replace("\r","")).map((c,d)=>{d+=1;if(c.startsWith("Misc\t")&&f){const z=c.split("\t");c={Off:"AF",On:"AO",Squelch:"SQ",Key:"KY","K+S":"KS"}[z[1]??""]??(k.push(N(d,"invalid backlight")),void 0);var h={Auto:0,Off:99}[z[2]??""]??(k.push(N(d,"invalid key beep")),void 0),g={On:1,Off:0}[z[3]??""]??(k.push(N(d,"invalid key lock")),void 0),y=R(z[4],1,15,{o:k,lineNumber:d,u:"invalid contrast"});const A=R(z[5],
1,14,{o:k,lineNumber:d,u:"invalid charge time"}),B=R(z[6],0,15,{o:k,lineNumber:d,u:"invalid volume"}),q=R(z[7],0,15,{o:k,lineNumber:d,u:"invalid squelch"});d={USA:0,Canada:1}[z[8]??""]??(k.push(N(d,"invalid band plan")),0);return[void 0!==c?["# Backlight","BLT,"+c]:[],void 0!==h&&void 0!==g?["# Key beep and lock","KBP,"+h+","+g]:[],void 0!==y?["# Contrast","CNT,"+y]:[],void 0!==A?["# Battery charge time","BSV,"+A]:[],void 0!==B?["# Volume","VOL,"+B]:[],void 0!==q?["# Squelch","SQL,"+q]:[],void 0!==
d?["# Band plan","BPL,"+d]:[]].flat().join("\n")}if(c.startsWith("Priority\t")&&f){c=c.split("\t");if(2>c.length)return"";d={Off:0,On:1,Plus:2,DND:3}[c[1]??""]??(k.push(N(d,"invalid priority")),void 0);return void 0!==d?`# Priority\nPRI,${d}`:""}if(c.startsWith("WxPri\t")&&f){c=c.split("\t");if(2>c.length)return"";d={Off:0,On:1}[c[1]??""]??(k.push(N(d,"invalid weather alert priority")),void 0);return void 0!==d?`# Weather alert priority\nWXS,${d}`:""}if(!c.startsWith("C-Freq\t"))return"";c=c.split("\t");
h=new P;g=parseInt(c[1]??"");if(1<=g&&500>=g)h.location=g;else return k.push(O(d,"invalid location: "+c[1])),"";g=c[2];void 0===g?k.push(N(d,`[channel ${h.location}] no name given`)):(!g.match(P.A)&&16>=g.length||k.push(N(d,`[channel ${h.location}] `+"invalid name, modifying/truncating: "+c[2])),h.name=g);g=parseInt(c[3]??"");Q(g)?h.frequency=g:k.push(N(d,`[channel ${h.location}] invalid frequency: `+c[3]));if(""===h.l&&0===h.j)return b?"DCH,"+h.location:"";g={Auto:P.g.v,AM:P.g.G,FM:P.g.H,NFM:P.g.I}[c[4]??
""];void 0!==g?h.C=g:k.push(N(d,`[channel ${h.location}] invalid mode: `+c[4]));h.h=127;"Off"===c[5]?h.h=0:"Srch"===c[5]?h.h=127:"NoTone"===c[5]?h.h=240:void 0!==c[5]&&c[5].match(/^[CD]/)?(g=parseFloat(c[5].slice(1)),"C"===c[5][0]?0<=P.m.indexOf(g)?h.L=g:k.push(N(d,`[channel ${h.location}] invalid CTCSS tone: `+c[5])):"D"===c[5][0]&&(0<=P.N.indexOf(g)?h.M=g:k.push(N(d,`[channel ${h.location}] invalid DCS code: `+c[5])))):void 0!==c[5]&&k.push(N(d,`[channel ${h.location}] unknown CTCSS/DCS setting: `+
c[5]));g={On:!0,Off:!1};y=g[c[6]??""];void 0!==y?h.B=y:k.push(N(d,`[channel ${h.location}] invalid lockout: `+c[6]));y=parseFloat(c[7]??"");0<=[-10,-5,0,1,2,3,4,5].indexOf(y)?h.delay=y:k.push(N(d,`[channel ${h.location}] invalid delay: `+c[7]));g=g[c[8]??""];void 0!==g?h.priority=g:k.push(N(d,`[channel ${h.location}] invalid priority: `+c[8]));return h.getCommand()}).filter(c=>c)}
async function ha(){if(!E){var a=document.getElementById("output");if(!(a instanceof HTMLTextAreaElement))throw Error("outputTextArea is not an HTMLTextAreaElement");E=new F(H(a))}await E.open();I.value="# Imported from scanner "+(new Date).toString()+"\n";X(I);try{await Y("PRG"),I.value+="PRG\n"}catch(f){I.value+=O(0,"error entering programming mode: "+f)+"\n"}try{I.value+=await Y("BPL")+"\n",I.value+=await Y("BLT")+"\n",I.value+=await Y("CNT")+"\n",I.value+=await Y("BSV")+"\n",I.value+=await Y("KBP")+
"\n",I.value+=await Y("PRI")+"\n",I.value+=await Y("WXS")+"\n",I.value+=await Y("SCO")+"\n",I.value+=await Y("VOL")+"\n",I.value+=await Y("SQL")+"\n",I.value+=await Y("SCG")+"\n",I.value+=await Y("CLC")+"\n",I.value+=await Y("SSG")+"\n",I.value+=await Y("CSG")+"\n"}catch(f){I.value+=O(0,"error reading setting: "+f)+"\n"}X(I);for(a=1;10>=a;a++){try{I.value+=await Y("CSP,"+a)+"\n"}catch(f){I.value+=O(0,"error reading custom search setting: "+f)+"\n"}X(I)}var b=document.getElementById("delete_empty_channels");
a=!1;b instanceof HTMLInputElement&&(a=b.checked);for(b=1;500>=b;b++){try{let f=(await Y("CIN,"+b)).split(",");if(""===f[2])if(f[1]&&"00000000"===f[3])if(a)f=["DCH",f[1]];else continue;else f[2]=" ";I.value+=f.join(",")+"\n"}catch(f){I.value+=O(0,"error reading channel: "+f)+"\n"}X(I)}X(I);try{I.value+=await Y("EPG")+"\n",await Y("EPG"),I.value+="EPG\n"}catch(f){I.value+=O(0,"error exiting programming mode: "+f)+"\n"}X(I)}
window.importFromScannerSync=function(){try{console.log("got here"),ha()}catch(a){alert("Aborting importing settings: "+(a instanceof Error)?a.message:"unknown")}};let E;function Q(a){return 0===a||25E6<=a&&54E6>=a||108E6<=a&&174E6>=a||225E6<=a&&38E7>=a||4E8<=a&&512E6>=a}
class P{constructor(){this.K=1;this.l="";this.j=0;this.C=P.g.v;this.h=0;this.J=2;this.priority=this.B=!1}get location(){return this.K}set location(a){1<=a&&500>=a&&(this.K=a)}get name(){return this.l}set name(a){this.l=a.slice(0,16).replace(P.A,"?")}get frequency(){return this.j}set frequency(a){Q(a)&&(this.j=a)}get O(){return this.h}set L(a){a=P.m.indexOf(a);0<=a&&(this.h=a+64)}set M(a){a=P.N.indexOf(a);0<=a&&(this.h=a+128)}get delay(){return this.J}set delay(a){this.J=-7.5>=a?-10:0>a?-5:.5>a?0:
1.5>a?1:2.5>a?2:3.5>a?3:4.5>a?4:5}getCommand(){let a="AUTO";switch(this.C){case P.g.v:a="AUTO";break;case P.g.G:a="AM";break;case P.g.H:a="FM";break;case P.g.I:a="NFM"}return["CIN",this.location,""===this.name?" ":this.name,("00000000"+Math.floor(this.frequency/100)).slice(-8),a,this.O,this.delay,this.B?"1":"0",this.priority?"1":"0"].join()}}P.A=/[^\x20-\x2B\x2D-\x7E]/g;
P.m=[67,69.3,71.9,74.4,77,79.7,82.5,85.4,88.5,91.5,94.8,97.4,100,103.5,107.2,110.9,114.8,118.8,123,127.3,131.8,136.5,141.3,146.2,151.4,156.7,159.8,162.2,165.5,167.9,171.3,173.8,177.3,179.9,183.5,186.2,189.9,192.8,196.6,199.5,203.5,206.5,210.7,218.1,225.7,229.1,233.6,241.8,250.3,254.1];
P.N=[23,25,26,31,32,36,43,47,51,53,54,65,71,72,73,74,114,115,116,122,125,131,132,134,143,145,152,155,156,162,165,172,174,205,212,223,225,226,243,244,245,246,251,252,255,261,263,265,266,271,274,306,311,315,325,331,332,343,346,351,356,364,365,371,411,412,413,423,431,432,445,446,452,454,455,462,464,465,466,503,506,516,523,526,532,546,565,606,612,624,627,631,632,654,662,664,703,712,723,731,732,734,743,754];var ia=P||={},Z=ia.g||(ia.g={});Z[Z.AUTO=0]="AUTO";Z[Z.AM=1]="AM";Z[Z.FM=2]="FM";Z[Z.NFM=3]="NFM";let I;window.clearResponses=function(){var a=document.getElementById("output");a instanceof HTMLTextAreaElement&&(a.value="");if(a=document.getElementById("error_count"))a.innerText="0"};function H(a){if(a instanceof HTMLTextAreaElement)return function(b,f){a.value+="["+b+"] "+f+"\n";X(a);"received"===b&&(b=f.split(","),"ERR"===b[0]||2<=b.length&&void 0!==b[1]&&["ERR","NG"].includes(b[1]))&&(b=document.getElementById("error_count"))&&(b.innerText=(parseInt(b.innerText)+1).toString())}}
async function ja(){if(!E){var a=document.getElementById("output");if(!(a instanceof HTMLTextAreaElement))throw Error("outputTextArea is not an HTMLTextAreaElement");E=new F(H(a))}await E.open();a=I.value.split("\n").filter(b=>!b.match(/^\s*(#.*)?$/));for(const b of a)await Y(b)}function ka(){try{ja()}catch(a){alert("Aborting sending commands: "+(a instanceof Error)?a.message:"unknown")}}window.sendCommandsSync=ka;
function la(){var a=document.getElementById("input");a&&(a=a.getAttribute("data-original"),I.value=a??"")}window.resetCommands=la;function X(a){a.scrollTo({top:a.scrollHeight,behavior:"instant"})}
document.addEventListener("DOMContentLoaded",function(){var a="usb"in navigator,b=document.getElementById("supported");b&&(b.innerText=a?"appears to be":"is not");b=document.getElementById("send");b instanceof HTMLInputElement&&(b.disabled=!a);a=document.getElementById("input");a instanceof HTMLTextAreaElement&&(I=a,a.focus(),a.addEventListener("keydown",function(f){const k=navigator.userAgent.includes("Mac");(k&&f.metaKey||!k&&f.ctrlKey)&&"Enter"===f.key&&(ka(),f.preventDefault())}));la()},!1);const ma={P:-1,R:23,S:26};async function Y(a){var b=E;await b.write(a);b=await b.read();if(b.split(",")[0]===a.split(",")[0])return b;throw Error("unexpected response to "+a+": "+b);}
class F{constructor(a){this.F=ma.P;this.i=()=>{};a&&(this.i=a,navigator.usb.addEventListener("connect",b=>{this.i("connected",b.device.productName||"")}),navigator.usb.addEventListener("disconnect",b=>{this.i("disconnected",b.device.productName||"")}))}async open(){if(!this.device||!this.device.opened){var a=(await navigator.usb.getDevices())?.at(0);a||=await navigator.usb.requestDevice({filters:[{vendorId:na}]});if(!a)throw Error("nothing connected");this.F=a.productId;Object.values(ma).includes(this.F)||
this.i("opening_unknown",this.F.toString());await a.open();for(const b of a.configurations)for(const f of b.interfaces)for(const k of f.alternates){if(k.interfaceClass!==oa)continue;let c,d;for(const h of k.endpoints)if("bulk"===h.type&&("in"===h.direction?c=h:"out"===h.direction&&(d=h),c&&d)){await a.selectConfiguration(b.configurationValue);await a.claimInterface(f.interfaceNumber);this.device=a;this.s=c;this.D=d;this.i("opened",a.productName||"");return}}throw Error("endpoints not found");}}async close(){if(this.device&&
this.device.opened)try{await this.device.close()}finally{this.D=this.s=void 0,this.i("closed",this.device?.productName??"")}}async write(a){if(!this.device||!this.device.opened||!this.D)throw Error("not connected");this.i("writing",a);await this.device.transferOut(this.D.endpointNumber,pa.encode(a+"\r"))}async read(){if(!this.device||!this.device.opened||!this.s)throw Error("not connected");for(var a="";;){var b=await this.device.transferIn(this.s.endpointNumber,this.s.packetSize);for(a+=qa.decode(b.data);0<=
(b=a.indexOf("\r"));)return a=a.slice(0,b),this.i("received",a),a}}}var pa=new TextEncoder,qa=new TextDecoder("ascii"),na=6501,oa=10;
