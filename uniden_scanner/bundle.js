const aa={G:-1,D:23,F:26};
async function ba(a){let b=(await navigator.usb.getDevices())?.at(0);b||=await navigator.usb.requestDevice({filters:[{classCode:ca,vendorId:ea}]});if(!b)throw Error("nothing connected");a=new fa(a);Object.values(aa).includes(b.productId)||a.g("opening_unknown",b.productId.toString());await b.open();for(const f of b.configurations)for(const k of f.interfaces)for(const c of k.alternates){if(c.interfaceClass!==ha)continue;let d,h;for(const g of c.endpoints)if("bulk"===g.type&&("in"===g.direction?d=g:
"out"===g.direction&&(h=g),d&&h))return a.g("opening",b.productName||""),await b.selectConfiguration(f.configurationValue),await b.claimInterface(k.interfaceNumber),a.device=b,a.h=d,a.i=h,a}throw Error("endpoints not found");}async function ia(a){if(!a.device?.opened||!a.h)throw Error("not connected");for(var b="";;){var f=await a.device.transferIn(a.h.endpointNumber,a.h.packetSize);b+=ja.decode(f.data);f=b.indexOf("\r");if(0<=f)return b=b.slice(0,f),a.g("received",b),b}}
async function e(a){var b=l;await b.write(a);b=await ia(b);if(b.split(",")[0]===a.split(",")[0])return b;throw Error("unexpected response to "+a+": "+b);}
class fa{constructor(a){this.i=this.h=this.device=void 0;this.g=()=>{};a?(this.g=a,navigator.usb.addEventListener("connect",b=>{this.g("connected",b.device.productName||"")}),navigator.usb.addEventListener("disconnect",b=>{this.g("disconnected",b.device.productName||"")})):this.g=()=>{}}async[Symbol.asyncDispose](){await this.close()}async close(){if(this.device?.opened)try{await this.device.close()}finally{this.i=this.h=void 0,this.g("closed",this.device?.productName??"")}}async write(a){if(!this.device?.opened||
!this.i)throw Error("not connected");this.g("writing",a);await this.device.transferOut(this.i.endpointNumber,ka.encode(a+"\r"))}}var ka=new TextEncoder,ja=new TextDecoder("ascii"),ea=6501,ca=2,ha=10;let l;async function t(a){l||=await ba(a)}function v(a){return 0===a||25E6<=a&&54E6>=a||108E6<=a&&174E6>=a||225E6<=a&&38E7>=a||4E8<=a&&512E6>=a}function w(a){let b="AUTO";switch(a.s){case 0:b="AUTO";break;case 1:b="AM";break;case 2:b="FM";break;case 3:b="NFM"}return["CIN",a.location,""===a.name?" ":a.name,("00000000"+Math.floor(a.h/100)).slice(-8),b,a.C,a.delay,a.o?"1":"0",a.priority?"1":"0"].join()}
class D{constructor(){this.v=1;this.l="";this.g=this.s=this.i=0;this.u=2;this.priority=this.o=!1}get location(){return this.v}set location(a){1<=a&&500>=a&&(this.v=a)}get name(){return this.l}set name(a){this.l=a.slice(0,16).replace(F,"?")}get h(){return this.i}set h(a){v(a)&&(this.i=a)}get C(){return this.g}set A(a){a=G.indexOf(a);0<=a&&(this.g=a+64)}set B(a){a=la.indexOf(a);0<=a&&(this.g=a+128)}get delay(){return this.u}set delay(a){this.u=-7.5>=a?-10:0>a?-5:.5>a?0:1.5>a?1:2.5>a?2:3.5>a?3:4.5>a?
4:5}}
var F=/[^\x20-\x2B\x2D-\x7E]/g,G=[67,69.3,71.9,74.4,77,79.7,82.5,85.4,88.5,91.5,94.8,97.4,100,103.5,107.2,110.9,114.8,118.8,123,127.3,131.8,136.5,141.3,146.2,151.4,156.7,159.8,162.2,165.5,167.9,171.3,173.8,177.3,179.9,183.5,186.2,189.9,192.8,196.6,199.5,203.5,206.5,210.7,218.1,225.7,229.1,233.6,241.8,250.3,254.1],la=[23,25,26,31,32,36,43,47,51,53,54,65,71,72,73,74,114,115,116,122,125,131,132,134,143,145,152,155,156,162,165,172,174,205,212,223,225,226,243,244,245,246,251,252,255,261,263,265,266,271,
274,306,311,315,325,331,332,343,346,351,356,364,365,371,411,412,413,423,431,432,445,446,452,454,455,462,464,465,466,503,506,516,523,526,532,546,565,606,612,624,627,631,632,654,662,664,703,712,723,731,732,734,743,754];function L(a,b){return"# Import error"+(a?", line "+a:"")+": "+b}function M(a,b){return"# Import warning"+(a?", line "+a:"")+": "+b}function N(a,b,f,{j:k,lineNumber:c,m:d,errorMessage:h}){const g=parseInt(a??"",10);if(Number.isNaN(g)||g<b||g>f){if(h){k.push(L(c,h+": "+a));return}if(d){k.push(M(c,d+": "+a));return}}return g}
function ma(a,b,f,k){k.push(M(0,"not all settings are imported"));return a.split("\n").map(c=>c.replace("\r","")).map((c,d)=>{d+=1;if(c.startsWith("Misc\t")&&f){const y=c.split("\t");c={Off:"AF",On:"AO",Squelch:"SQ",Key:"KY","K+S":"KS"}[y[1]??""]??(k.push(M(d,"invalid backlight")),void 0);var h={Auto:0,Off:99}[y[2]??""]??(k.push(M(d,"invalid key beep")),void 0),g={On:1,Off:0}[y[3]??""]??(k.push(M(d,"invalid key lock")),void 0),x=N(y[4],1,15,{j:k,lineNumber:d,m:"invalid contrast"});const z=N(y[5],
1,14,{j:k,lineNumber:d,m:"invalid charge time"}),A=N(y[6],0,15,{j:k,lineNumber:d,m:"invalid volume"}),p=N(y[7],0,15,{j:k,lineNumber:d,m:"invalid squelch"});d={USA:0,Canada:1}[y[8]??""]??(k.push(M(d,"invalid band plan")),0);return[void 0!==c?["# Backlight","BLT,"+c]:[],void 0!==h&&void 0!==g?["# Key beep and lock","KBP,"+h+","+g]:[],void 0!==x?["# Contrast","CNT,"+x]:[],void 0!==z?["# Battery charge time","BSV,"+z]:[],void 0!==A?["# Volume","VOL,"+A]:[],void 0!==p?["# Squelch","SQL,"+p]:[],void 0!==
d?["# Band plan","BPL,"+d]:[]].flat().join("\n")}if(c.startsWith("Priority\t")&&f){c=c.split("\t");if(2>c.length)return"";d={Off:0,On:1,Plus:2,DND:3}[c[1]??""]??(k.push(M(d,"invalid priority")),void 0);return void 0!==d?`# Priority\nPRI,${d}`:""}if(c.startsWith("WxPri\t")&&f){c=c.split("\t");if(2>c.length)return"";d={Off:0,On:1}[c[1]??""]??(k.push(M(d,"invalid weather alert priority")),void 0);return void 0!==d?`# Weather alert priority\nWXS,${d}`:""}if(!c.startsWith("C-Freq\t"))return"";c=c.split("\t");
h=new D;g=parseInt(c[1]??"",10);if(1<=g&&500>=g)h.location=g;else return k.push(L(d,"invalid location: "+c[1])),"";g=c[2];void 0===g?k.push(M(d,`[channel ${h.location}] no name given`)):(!g.match(F)&&16>=g.length||k.push(M(d,`[channel ${h.location}] `+"invalid name, modifying/truncating: "+c[2])),h.name=g);g=parseInt(c[3]??"",10);v(g)?h.h=g:k.push(M(d,`[channel ${h.location}] invalid frequency: `+c[3]));if(""===h.l&&0===h.i)return b?"DCH,"+h.location:"";g={Auto:0,AM:1,FM:2,NFM:3}[c[4]??""];void 0!==
g?h.s=g:k.push(M(d,`[channel ${h.location}] invalid mode: `+c[4]));h.g=127;"Off"===c[5]?h.g=0:"Srch"===c[5]?h.g=127:"NoTone"===c[5]?h.g=240:void 0!==c[5]&&c[5].match(/^[CD]/)?(g=parseFloat(c[5].slice(1)),"C"===c[5][0]?0<=G.indexOf(g)?h.A=g:k.push(M(d,`[channel ${h.location}] invalid CTCSS tone: `+c[5])):"D"===c[5][0]&&(0<=la.indexOf(g)?h.B=g:k.push(M(d,`[channel ${h.location}] invalid DCS code: `+c[5])))):void 0!==c[5]&&k.push(M(d,`[channel ${h.location}] unknown CTCSS/DCS setting: `+c[5]));g={On:!0,
Off:!1};x=g[c[6]??""];void 0!==x?h.o=x:k.push(M(d,`[channel ${h.location}] invalid lockout: `+c[6]));x=parseFloat(c[7]??"");0<=[-10,-5,0,1,2,3,4,5].indexOf(x)?h.delay=x:k.push(M(d,`[channel ${h.location}] invalid delay: `+c[7]));g=g[c[8]??""];void 0!==g?h.priority=g:k.push(M(d,`[channel ${h.location}] invalid priority: `+c[8]));return w(h)}).filter(c=>c)}
async function na(){if(!l){var a=document.getElementById("output");if(!(a instanceof HTMLTextAreaElement))throw Error("outputTextArea is not an HTMLTextAreaElement");await t(O(a))}if(!l)throw Error("Unable to create UnidenScanner class.");P.value="# Imported from scanner "+(new Date).toString()+"\n";Q(P);try{await e("PRG"),P.value+="PRG\n"}catch(f){P.value+=L(0,"error entering programming mode: "+f)+"\n"}try{P.value+=await e("BPL")+"\n",P.value+=await e("BLT")+"\n",P.value+=await e("CNT")+"\n",P.value+=
await e("BSV")+"\n",P.value+=await e("KBP")+"\n",P.value+=await e("PRI")+"\n",P.value+=await e("WXS")+"\n",P.value+=await e("SCO")+"\n",P.value+=await e("VOL")+"\n",P.value+=await e("SQL")+"\n",P.value+=await e("SCG")+"\n",P.value+=await e("CLC")+"\n",P.value+=await e("SSG")+"\n",P.value+=await e("CSG")+"\n"}catch(f){P.value+=L(0,"error reading setting: "+f)+"\n"}Q(P);for(a=1;10>=a;a++){try{P.value+=await e("CSP,"+a)+"\n"}catch(f){P.value+=L(0,"error reading custom search setting: "+f)+"\n"}Q(P)}var b=
document.getElementById("delete_empty_channels");a=!1;b instanceof HTMLInputElement&&(a=b.checked);for(b=1;500>=b;b++){try{let f=(await e("CIN,"+b)).split(",");if(""===f[2])if(f[1]&&"00000000"===f[3])if(a)f=["DCH",f[1]];else continue;else f[2]=" ";P.value+=f.join(",")+"\n"}catch(f){P.value+=L(0,"error reading channel: "+f)+"\n"}Q(P)}Q(P);try{await e("EPG"),P.value+="EPG\n"}catch(f){P.value+=L(0,"error exiting programming mode: "+f)+"\n"}Q(P)};let P;function O(a){if(a instanceof HTMLTextAreaElement)return function(b,f){a.value+="["+b+"] "+f+"\n";Q(a);"received"===b&&(b=f.split(","),"ERR"===b[0]||2<=b.length&&void 0!==b[1]&&["ERR","NG"].includes(b[1]))&&(b=document.getElementById("error_count"))&&(b.innerText=(parseInt(b.innerText,10)+1).toString())}}
async function oa(){if(!l){var a=document.getElementById("output");if(!(a instanceof HTMLTextAreaElement))throw Error("outputTextArea is not an HTMLTextAreaElement");await t(O(a))}if(!l)throw Error("Unable to create UnidenScanner class.");a=P.value.split("\n").filter(b=>!b.match(/^\s*(#.*)?$/));for(const b of a)await e(b)}function pa(){try{oa()}catch(a){alert("Aborting sending commands: "+(a instanceof Error)?a.message:"unknown")}}
function qa(){var a=document.getElementById("input");a&&(a=a.getAttribute("data-original"),P.value=a??"")}function Q(a){a.scrollTo({top:a.scrollHeight,behavior:"instant"})}
document.addEventListener("DOMContentLoaded",function(){var a="usb"in navigator,b=document.getElementById("supported");b&&(b.innerText=a?"appears to be":"is not");b=document.getElementById("send");b instanceof HTMLInputElement&&(b.disabled=!a);a=document.getElementById("input");a instanceof HTMLTextAreaElement&&(P=a,a.focus(),a.addEventListener("keydown",function(f){const k=navigator.userAgent.includes("Mac");(k&&f.metaKey||!k&&f.ctrlKey)&&"Enter"===f.key&&(pa(),f.preventDefault())}));qa()},!1);
window.clearResponses=function(){var a=document.getElementById("output");a instanceof HTMLTextAreaElement&&(a.value="");if(a=document.getElementById("error_count"))a.innerText="0"};
window.importFile=function(){const a=document.getElementById("delete_empty_channels"),b=document.getElementById("import_all_settings");let f=!1;a instanceof HTMLInputElement&&(f=a.checked);let k=!1;b instanceof HTMLInputElement&&(k=b.checked);const c=document.createElement("input");c.accept=".bc125at_ss,.csv,.tsv,.txt,text/csv,text/plain,text/tab-separated-values";c.type="file";c.onchange=async()=>{if(c.files){P.value="";var d=[];f||d.push(M(0,"ignored empty channels"));k||d.push(M(0,"dropping non-channel settings"));
var h=["# Enter programming mode","PRG"];for(const R of c.files){d.push("# Imported "+R.name);d.push("# Last modified "+(new Date(R.lastModified)).toString());var g=await R.text();if(g.match("^(C-Freq|CloseCall|CloseCallBands|Conventional|Custom|GeneralSearch|Misc|Priority|Service|WxPri)\t"))h.push(...ma(g,f,k,d));else if(!g.match(/^[0-9.]+\r?\n/))if(g.match(/\t/))d.push(L(1,"unknown file format"));else{var x=h,y=x.push;{let S=void 0,H=void 0,E=void 0,T=void 0,U=void 0,I=void 0,J=void 0,K=void 0;
var z=f;const V=[];b:{for(var A=/^(?:(?<nonescaped>[^\u0000-\u001F",]+)|(?:"(?<escaped>(?:[^"]|"")*)")|)(?<next>[,\n]|\r\n|$)/,p=[],r=[];g;){var n=A.exec(g);if(!n||void 0===n[0]||!n.groups)throw Error("invalid CSV");g=g.slice(n[0].length);var m="",q=n.groups.nonescaped,u=n.groups.escaped;n=n.groups.next;void 0!==q?m=q:void 0!==u&&(m=u.replace(/""/g,'"'));r.push(m);if(","!==n)if(n&&0<=["\n","\r\n"].indexOf(n))p.push(r),r=[];else{p.push(r);g=p;break b}}r.length&&p.push(r);g=p}if(g)if(p=g[0],A=void 0,
p&&(A=p.indexOf("Location"),K=p.indexOf("Name"),J=p.indexOf("Frequency"),I=p.indexOf("Tone"),U=p.indexOf("cToneFreq"),T=p.indexOf("rToneFreq"),E=p.indexOf("DtcsCode"),H=p.indexOf("Mode"),S=p.indexOf("Skip")),void 0===A)d.push(L(0,"Location field not found")),z=[];else if(void 0===J)d.push(L(0,"Frequency field not found")),z=[];else{for(p=1;p<g.length;++p)if(r=p+1,q=g[p],void 0===q)d.push(L(r,"invalid row"));else{m=new D;u=parseInt(q[A]??"",10);if(1<=u&&500>=u)m.location=u;else if(0===u)d.push(M(r,
"invalid location 0, using channel 500")),m.location=500;else{d.push(L(r,"invalid location: "+q[A]));continue}void 0!==K&&(n=q[K],void 0===n?d.push(M(r,`[channel ${m.location}] no name given`)):(u=n,!u.match(F)&&16>=u.length||d.push(M(r,`[channel ${m.location}] `+"invalid name, modifying/truncating: "+q[K])),m.name=n));u=1E6*parseInt(q[J]??"",10);v(u)?m.h=u:d.push(M(r,`[channel ${m.location}] invalid frequency: `+q[J]));if(""===m.l&&0===m.i)z&&V.push("DCH,"+m.location);else{void 0!==H&&(u={Auto:0,
AM:1,FM:2,NFM:3}[q[H]??""],void 0!==u?m.s=u:d.push(M(r,`[channel ${m.location}] invalid mode: `+q[H])));m.g=127;if(void 0!==I)if(n=q[I]??"","TSQL"===n||"Tone"===n){let B=U;u=T;"TSQL"===n&&(B=T,u=U);try{n=B;void 0===n&&(n=u);const C=void 0!==n?q[n]:void 0;if(void 0===C)throw Error("no CTCSS tone given");const da=parseFloat(C);0<=G.indexOf(da)?m.A=da:d.push(M(r,`[channel ${m.location}] invalid CTCSS tone: `+q[I]))}catch(C){d.push(M(r,`[channel ${m.location}] error with CTCSS tone: `+(C instanceof Error)?
C.message:"unknown"))}}else if("DTCS"===n)try{const B=void 0!==E?q[E]:void 0;if(void 0===E||void 0===B)throw Error("no DCS code given");const C=parseFloat(B);0<=G.indexOf(C)?m.B=C:d.push(M(r,`[channel ${m.location}] invalid DCS code: `+q[E]))}catch(B){d.push(M(r,`[channel ${m.location}] error with DCS code: `+(B instanceof Error)?B.message:"unknown"))}else""!==n&&d.push(M(r,`[channel ${m.location}] unsupported tone mode`));void 0!==S&&(q=q[S]??"",""!==q&&("S"===q?m.o=!0:"P"===q?m.priority=!0:d.push(M(r,
`[channel ${m.location}] unsupported skip setting`))));V.push(w(m))}}z=V}else d.push(L(0,"empty file")),z=[]}y.call(x,...z)}}h.push("# Exit programming mode\nEPG");P.value=d.concat(h).join("\n")+"\n"}};c.click()};window.importFromScannerSync=function(){try{na()}catch(a){alert("Aborting importing settings: "+(a instanceof Error)?a.message:"unknown")}};window.resetCommands=qa;window.sendCommandsSync=pa;window.toggleSendGPSTimerSync=ra;window.toggleWatchGPSPositionSync=sa;let W,X,Y;function ta(a,b){if(null==a)return",";const f=Math.round(6E5*Math.abs(a));return Math.floor(f/6E5).toString().padStart(b?3:2,"0")+(f/1E4%60).toFixed(4).padStart(7,"0")+","+(0>a?b?"W":"S":b?"E":"N")}function Z(a,b,f){return a<b?b:a>f?f:a}function ua(a){return a+"*"+a.split("").map(b=>b.charCodeAt(0)).reduce((b,f)=>b^f).toString(16).toUpperCase().padStart(2,"0")}
async function va(){var a=Y;if(!l)throw Error("not connected");var b=new Date;b=b.getUTCHours().toString().padStart(2,"0")+b.getUTCMinutes().toString().padStart(2,"0")+b.getUTCSeconds().toString().padStart(2,"0");const f=ta(Z(a.latitude,-90,90),!1),k=ta(((a.longitude+180)%360+360)%360-180,!0),c=null==a.altitude?"":Z(Math.round(a.altitude),Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER).toString();await l.write("$"+ua(`GPRMC,${b},A,`+`${f},${k},${null==a.speed?"":(1.94384449244*Z(a.speed,0,299792458)).toFixed(0)},`+
`${null==a.heading?"":((Math.round(a.heading)%360+360)%360).toString().padStart(3,"0")}`));await l.write("$"+ua(`GPGGA,${b},`+`${f},${k},1,,,${c},M`))}async function wa(){const a=document.getElementById("gps_info");X?(navigator.geolocation.clearWatch(X|0),X=void 0,a&&(a.innerText="(stopped) "+a.innerText)):X=navigator.geolocation.watchPosition(b=>{Y=b.coords;a&&(a.innerText=(new Date).toString()+": "+JSON.stringify(b.coords))})}
function sa(){try{wa()}catch(a){alert("Aborting toggling watching GPS position: "+(a instanceof Error)?a.message:"unknown")}}async function xa(){"undefined"!==typeof Y&&l&&await va();W=window.setTimeout(xa,2E3)}async function ya(){const a=document.getElementById("output");a instanceof HTMLTextAreaElement&&await t(O(a));if(!l)throw Error("Unable to create UnidenScanner class.");W?(clearTimeout(W),W=void 0):await xa()}
function ra(){try{ya()}catch(a){alert("Aborting sending GPS information: "+(a instanceof Error)?a.message:"unknown")}};
